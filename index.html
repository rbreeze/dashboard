<!DOCTYPE HTML>
<head>
  <link rel="stylesheet" href="style.css" type="text/css">
  <link rel="stylesheet" href="chartist.min.css" type="text/css">
  <meta name="viewport" content="width=device-width, initial-scale=.85, maximum-scale=1">
</head>
<html>
<body>

  <div class="modules-container">
      <h1 class="name">Remington Breeze</h1>
      <div class="1"></div>
      <div class="2"></div>
  </div>
  

  <script src="http://code.jquery.com/jquery-latest.min.js"></script>
  <script src="chartist.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/3.5.3/math.min.js"></script>
  <script>

    //Urls to Google Sheets where data is held
    var morningUrl = "https://spreadsheets.google.com/tq?key=1fYj_mJEjc7ov_ALP-YOxcPDm_U5aRwg09-CU78Uo-fI&tqx=out:csv&callback=processData&sheet=sortedData"; 
    var nightUrl = "https://spreadsheets.google.com/tq?key=1gZpe3gFUQ36xsDtZBNBlEBvNy718axyTfFg0d8R58Ik&tqx=out:csv&callback=processData&sheet=sortedData";

    //returns the average of the array that is passed
    function average(array) {
      var total = 0; 
      for (item in array) {
        total += parseFloat(array[item]); 
      }
      return total / array.length; 
    }

    //converts duration to float
    function timeStringToFloat(time) {
      var hoursMinutes = time.split(/[.:]/);
      var hours = parseInt(hoursMinutes[0], 10);
      var minutes = hoursMinutes[1] ? parseInt(hoursMinutes[1], 10) : 0;
      return hours + minutes / 60;
    }

    //function that takes Google Sheets data rows and sorts them into an object containing Arrays for each column
    function sortData(data) { 
      var categories = new Array(); 
      var sorted = {};

      var i = 0; 
        for (category in data[0]) {
          categories[i] = data[0][category];
          i++;
        }
        var j = 0; 
        for (row in data) {
          sorted[categories[j]] = new Array();
          j++;
        }
        var l = 0; 
        for (row in data) {
          var k = 0; 
          for (column in data[row]) {
            if (data[row][column] != null && data[row][column] != 0) {
              sorted[categories[k]][l] = data[row][column];
            } else {
              sorted[categories[k]][l] = 0;
            }
            k++;
          }
          l++;
        }
        return sorted;
    }

    //appends a Chartist Line to the body with the ID that is passed to the function
    function createModule(unescapedID, data, order, unit, options) {

      var id = unescapedID.replace(/[^A-Z0-9]+/ig, "_");

      // ** NOTE ** 
      // This function assumes that data is an unformatted array, not a Javascript object formatted for Chartist.
      // The first item of this array should be a label.

      //save the first item and then remove it
      var label = data[0];
      data.shift(); 

      //if the user didn't pass a unit, assume it is grams
      if (!unit) {
        unit = "G";
      }

      //Create the div to hold the module
      var $module = $("<div>", {id: id, "class": "module"});
      $('.' + order).append($module);

      //create the header
      var $header = $("<div>", {"class": "header"});
        var $small = $("<div>", {"class": "small-text"}); 
        var $h1 = $("<h1>");
      $h1.append(label);
      $small.append("This Month");
      $header.append($small);
      $header.append($h1);
      $('#' + id).append($header); 

      //create the chart container 
      var $chart = $("<div>", {"id": id + "-chart","class": "chart"});
      $('#' + id).append($chart); 

      //calculate some useful metrics
      var avg = Math.round(average(data)*100)/100;
      var min = Math.min(...data);
      var max = Math.max(...data);

      //create the footer
      var $footer = $("<div>", {"class": "footer"});  

        //create the left data
        var $left = $("<div>", {"class": "left"});

          //light text on the left
          var $light = $("<div>", {"class": "light-text"});
          $light.append("Average");

          //create data on the right
          var $data = $("<div>", {"class": "footer-data"}); 
            var $top = $("<div>", {"class": "top-data"});
            var $red = $("<div>", {"class": "small-text"});
            $top.append(avg + " " + unit);
            $red.append("StdDev: " + Math.round(math.std(data)));

          //append to div
          $data.append($top);
          $data.append($red); 

          //append all to left box
          $left.append($light); 
          $left.append($data); 

        //create the right data
        var $right = $("<div>", {"class": "right"});

          //create data container
          var $container = $("<div>", {"class": "data-container"});
            var $redData = $("<div>", {"class": "red-data"}); 

          //set up second data container
          $redData.append(max + " " + unit);
          $container.append("Max"); 
          $container.append($redData);

        //append two identical containers into the right box
        $right.append($container);
        $right.append($container.clone());

          //edit the original to create the first container
            $redData.html(min + " " + unit);
            $container.html("Min");
            $container.append($redData);

        //append left and right to footer
        $footer.append($left); 
        $footer.append($right);

      $('#' + id).append($footer); 

      //if the user doesn't pass any options, use these default ones
      if (!options) {
        options = {
          stretch: true, 
          fullWidth: true,
          axisX: {
            showLabel: false,
            offset: 0
          }, 
          axisY: {
            offset: 25
          },
          chartPadding: {
            top: 20,
            bottom: 8,
            left: 13, 
            right: 13
          }
        }
      }

      var formattedData = {
        series: [data]
      }

      Chartist.Line("#" + id + "-chart", formattedData, options);

    }

    //function for grabbing data from google sheet
    function getData(url, order) {
      var sheetData; 
      $.ajax({
        // Call Yahoo query API 
        url: 'http://query.yahooapis.com/v1/public/yql', 
        dataType: "jsonp",
        data: { 
          q: "select * from csv(0, 20) where url='" + url + "'",
          format: 'json'
        },
        success: function(data) {
          //Upon success, sort the data into an object
          sheetData = sortData(data.query.results.row);

          //Get rid of ungraphable arrays
          delete sheetData.undefined;
          var timeStamps = sheetData.Timestamp;
          delete sheetData.Timestamp;
          delete sheetData.Time;

          //convert sleep durations to a decimal
          if(sheetData.Sleep) {
            for (i in sheetData.Sleep) {
              if (i != 0 && sheetData.Sleep[i] != null && sheetData.Sleep[i] != 0) {
                sheetData.Sleep[i] = Math.round(timeStringToFloat(sheetData.Sleep[i])*100) / 100;
              }
            }
          }

          //Create a chart for each category
          for (category in sheetData) {
            createModule(sheetData[category][0], sheetData[category], order);
          }

        }
      }); 
    }

    getData(morningUrl, 2); 
    getData(nightUrl, 1);

  </script>

</body>
</html>