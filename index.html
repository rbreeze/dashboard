<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
</head>

<body>

	<div class="navigation">
		<a class="back button">Back</a>
		<a class="forward button">Forward</a>
	</div>

	<div class="mileage container">
		<h1>Mileage- <span class="whichWeek">This Week</span></h1>
		<canvas id="mileage" class="canvas"></canvas>
	</div>

	<div class="sleep container">
		<h1>Sleep- <span class="whichWeek">This Week</span></h1>
		<canvas id="sleep" class="canvas"></canvas>
	</div>

	<div class="carbs container">
		<h1>Carbs &amp; Sugar- <span class="whichWeek">This Week</span></h1>
		<canvas id="carbs" class="canvas"></canvas>
	</div>

	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="jquery-csv.min.js"></script>
	<script src="Chart.min.js"></script>
	<script src="chartData.js"></script>
    <script type="text/javascript">
    $(document).ready(function() {

    	//establish some variables    	
    	var urlStem = "https://spreadsheets.google.com/tq?key=";
   		var query = "&tqx=out:csv&callback=processData"
    	var mileageUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Mileage'
    	var paceUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Paces';
    	var sleepUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Sleep';
    	var nutrientsUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Macronutrients';

    	var week = 0;

    	function newChart(url, url2, valueColumn, name, chartType, options, week, color, valueColumn2) {
    		var values = new Array();
    		var labels = new Array();

    		clearCanvas(name);

    		$.ajax({
	        	url: 'http://query.yahooapis.com/v1/public/yql', 
	        	dataType: "jsonp",
	        	data: { 
		            q: "select * from csv where url='" + url + "'",
		            format: 'json'
          		},
	        	success: function(data) {
		    		$.each(data.query.results.row, function(index, object) {
		        		if(index !== "0") {
		        			switch (valueColumn) {
		        				case 1: 
				        			values[index-1] = parseFloat(data.query.results.row[index].col1);
				        			break;
				        		case 2: 
				        			values[index-1] = parseFloat(data.query.results.row[index].col2);
				        			break;
				        		default: 
				        			values[index-1] = parseFloat(data.query.results.row[index].col1);
				        			break;
		        			}
		        			labels[index-1] = data.query.results.row[index].col0;
		        		}
				    });

		        	var uiFont = 'Open Sans';
			    	var chartDefaults = {
			    		scaleFontFamily: uiFont,
			    		tooltipFontFamily: uiFont,
						pointLabelFontFamily: uiFont,
					  	tooltipTitleFontStyle : 'normal'
			    	}

			    	var weeklyData = getWeek(values, week);
			    	var thisWeeksLabels = getWeek(labels, week);

			       	var chartData = convertToChartData(color, name, thisWeeksLabels, weeklyData, null);

			       	if (url2) {
			       		if (!valueColumn2)
			       			valueColumn2 = valueColumn;
			       		var values2 = new Array();
				    	$.ajax({
				    		url: 'http://query.yahooapis.com/v1/public/yql', 
				        	dataType: "jsonp",
				        	data: { 
					            q: "select * from csv where url='" + url2 + "'",
					            format: 'json'
			          		},
			          		success: function(data) {
			          			$.each(data.query.results.row, function(index, object) {
					        		if(index !== "0") { 
					        			switch (valueColumn2) {
					        				case 1: 
							        			values2[index-1] = parseFloat(data.query.results.row[index].col1);
							        			break;
							        		case 2: 
							        			values2[index-1] = parseFloat(data.query.results.row[index].col2);
							        			break;
							        		default: 
							        			values2[index-1] = parseFloat(data.query.results.row[index].col1);
							        			break;
					        			}
					        		}
							    });

							    var weeklyData2 = getWeek(values2, week);

							    var chartData2 = convertToChartData(color, name, thisWeeksLabels, weeklyData2);

							    chartData2.datasets[0].data = values2;
							    chartData2 = chartData2.datasets[0];

							    chartData.datasets[1] = chartData2;
							    
		    				   	var ctx = document.getElementById(name).getContext("2d");
						    	var myChart = new Chart(ctx);
						    	myChart.Line(chartData, chartDefaults);
						    	return;
			          		}
				    	})
				    }

				   	var ctx = document.getElementById(name).getContext("2d");
			    	var myChart = new Chart(ctx);
			    	myChart.Line(chartData, chartDefaults);

	        	},
	        	error: function() { console.log("Error! Failed to get data set."); }
        	});
    	}

    	function getWeek(data, weeksAgo) {
    		return data.reverse().slice((7*weeksAgo), ((7*weeksAgo)+7)).reverse();
    	}

    	function clearCanvas(name) {
			$('#' + name).replaceWith('<canvas id="'+name+'" class="canvas"></canvas>');
    	}

    	function updateGraphs() {

	    	newChart(mileageUrl, paceUrl, 1, "mileage", "Line", null, week, "red");
			newChart(sleepUrl, null, 1, "sleep", "Line", null, week, "orange");
			newChart(nutrientsUrl, nutrientsUrl, 1, "carbs", "Line", null, week, "green", 2);

			if (week <= 0) {
				$('.forward').hide();
			} else {
				$('.forward').show();
			}

			if (week == 0) {
				$('.whichWeek').html('This Week');
			} else if (week == 1) {
				$('.whichWeek').html('Last Week');
			} else {
				$('.whichWeek').html(week + ' Weeks Ago');
			}
    	}

    	updateGraphs();
        
		$('.back').click(function() {
			week += 1; 
			updateGraphs();
		});
		$('.forward').click(function() {
			week -= 1; 
			updateGraphs();
		});

	});  
    </script>
</body>
</html>

