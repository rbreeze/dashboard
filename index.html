<html>
<head>
<link rel="stylesheet" href="style.css" type="text/css">
</head>

<body>

	<div class="navigation">
		<a class="back button">Back</a>
		<a class="forward button">Forward</a>
	</div>

	<div class="mileage container">
		<h1>Mileage- <span class="whichWeek">This Week</span></h1>
		<canvas id="mileage" class="canvas"></canvas>
	</div>

	<div class="sleep container">
		<h1>Sleep- <span class="whichWeek">This Week</span></h1>
		<canvas id="sleep" class="canvas"></canvas>
	</div>

	<div class="carbs container">
		<h1>Carbs &amp; Sugar- <span class="whichWeek">This Week</span></h1>
		<canvas id="carbs" class="canvas"></canvas>
	</div>

	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="jquery-csv.min.js"></script>
	<script src="Chart.min.js"></script>
    <script type="text/javascript">
    $(document).ready(function() {
    	var data; 
    	var urlStem = "https://spreadsheets.google.com/tq?key=";
   		var query = "&tqx=out:csv&callback=processData"
    	var mileageUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Mileage'
    	var paceUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Paces';
    	var sleepUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Sleep';
    	var nutrientsUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Macronutrients';

    	week = 0;

    	function processData(data) {
    		alert(data);
    	}

    	function getAndGraphDataSet(url, valueColumn, name, chartType, options, week, color) {
    		var values = new Array();
    		var labels = new Array();

    		$.ajax({
	        	url: 'http://query.yahooapis.com/v1/public/yql', 
	        	dataType: "jsonp",
	        	data: { 
		            q: "select * from csv where url='" + url + "'",
		            format: 'json'
          		},
	        	success: function(data) {
		        	$.each(data.query.results.row, function(index, object) {
		        		if(index !== "0") { 
		        			values[index-1] = parseFloat(data.query.results.row[index].col1);
		        			labels[index-1] = data.query.results.row[index].col0;
		        		}
		        	});

		        	var uiFont = 'Open Sans';
			    	var chartDefaults = {
			    		scaleFontFamily: uiFont,
			    		tooltipFontFamily: uiFont,
						pointLabelFontFamily: uiFont,
					  	tooltipTitleFontStyle : 'normal'
			    	}

			    	var weeklyData = getWeek(values, week);
			    	var thisWeeksLabels = getWeek(labels, week);

			       	switch(color) {
			       		case "red": 
				       		var chartData = {
						        labels: thisWeeksLabels,
						        datasets: [{
						        	label: name,
				            		fillColor : "rgba(234,120,123,0.4)",
				            		strokeColor : "rgba(175,0,3,1.0)",
				            		pointColor : "#fff",
				            		pointStrokeColor : "rgba(139,0,5,1.0)",
				        			data: weeklyData
				        		}]
				    		}
				    		break;
				    	case "orange": 
				       		var chartData = {
						        labels: thisWeeksLabels,
								datasets: [{
						        	label: name,
				            		fillColor : "rgba(228,136,76,0.4)",
				            		strokeColor : "rgba(182,71,4,1.0)",
				            		pointColor : "#fff",
				            		pointStrokeColor : "rgba(182,71,4,1.0)",
				        			data: weeklyData
				        		}]				    		
				        	}
				        	break;
				    	case "green": 
				       		var chartData = {
						        labels: thisWeeksLabels,
								datasets: [{
						        	label: name,
				            		fillColor : "rgba(105,235,124,0.4)",
				            		strokeColor : "rgba(19,145,12,1.0)",
				            		pointColor : "#fff",
				            		pointStrokeColor : "rgba(19,145,12,1.0)",
				        			data: weeklyData
				        		}]				    		
				        	}
				        	break;
				    	case "blue": 
				       		var chartData = {
						        labels: thisWeeksLabels,
								datasets: [{
						        	label: name,
				            		fillColor : "rgba(70,127,230,0.4)",
				            		strokeColor : "rgba(7,66,146,1.0)",
				            		pointColor : "#fff",
				            		pointStrokeColor : "rgba(7,66,146,1.0)",
				        			data: weeklyData
				        		}]				    		
				        	}
				        	break;
				        default: 
				        	var chartData = {
						        labels: thisWeeksLabels,
						        datasets: [{
						        	label: name,
				            		fillColor : "rgba(234,120,123,0.4)",
				            		strokeColor : "rgba(175,0,3,1.0)",
				            		pointColor : "#fff",
				            		pointStrokeColor : "rgba(139,0,5,1.0)",
				        			data: weeklyData
				        		}]
				    		}
				    		break;

			       	}

				   	var ctx = document.getElementById(name).getContext("2d");
			    	var myChart = new Chart(ctx);
			    	myChart.Line(chartData, chartDefaults);

	        	},
	        	error: function() { console.log("Error! Failed to get data set."); }
        	});
    	}

    	function getWeek(data, weeksAgo) {
    		return data.reverse().slice((7*weeksAgo), ((7*weeksAgo)+7)).reverse();
    	}

    	function clearCanvas(name) {
    		var html = $('.' + name).html();
			$('.' + name).html("");
			$('.' + name).html(html);	
    	}

    	function updateGraphs() {
    		clearCanvas('mileage');
    		clearCanvas('sleep');
    		clearCanvas('carbs');

	    	getAndGraphDataSet(mileageUrl, 1, "mileage", "Line", null, week, "red");
			getAndGraphDataSet(sleepUrl, 1, "sleep", "Line", null, week, "orange");
			getAndGraphDataSet(nutrientsUrl, 1, "carbs", "Line", null, week, "green");

			if (week <= 0) {
				$('.forward').hide();
			} else {
				$('.forward').show();
			}

			if (week == 0) {
				$('.whichWeek').html('This Week');
			} else if (week == 1) {
				$('.whichWeek').html('Last Week');
			} else {
				$('.whichWeek').html(week + ' Weeks Ago');
			}
    	}

    	updateGraphs();
        
		$('.back').click(function() {
			week += 1; 
			console.log(week);
			updateGraphs();
		});
		$('.forward').click(function() {
			week -= 1; 
			console.log(week);
			updateGraphs();
		});

	});  
    </script>
</body>
</html>

