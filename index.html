<html>
<head>
<title>Health Data- Remington Breeze</title>
<link rel="stylesheet" href="style.css" type="text/css">
</head>

<body>

	<div class="navigation">
		<a class="back button">Back</a>
		<a class="forward button">Forward</a>
		<a class="week button">Week View</a>
		<a class="month button">Month View</a>
	</div>

	<div class="mileage container">
		<h1>Mileage- <span class="whichWeek">This Week</span></h1>
		<canvas id="mileage" class="canvas"></canvas>
	</div>

	<div class="sleep container">
		<h1>Sleep- <span class="whichWeek">This Week</span></h1>
		<canvas id="sleep" class="canvas"></canvas>
	</div>

	<div class="carbs container">
		<h1>Carbs &amp; Sugar- <span class="whichWeek">This Week</span></h1>
		<canvas id="carbs" class="canvas"></canvas>
	</div>

	<div class="protein container">
		<h1>Protein- <span class="whichWeek">This Week</span></h1>
		<canvas id="protein" class="canvas"></canvas>
	</div>

	<div class="protein container">
		<h1>Fat &amp; SatFat- <span class="whichWeek">This Week</span></h1>
		<canvas id="fat" class="canvas"></canvas>
	</div>

	<div class="calories container">
		<h1>Calories- <span class="whichWeek">This Week</span></h1>
		<canvas id="calories" class="canvas"></canvas>
	</div>

	<div class="avgMacronutrients container">
		<h1>Macronutrient Breakdown- <span class="doughnutTime">Last Week</span></h1>
		<canvas id="avgMacronutrients" class="canvas"></canvas>
	</div>

	<script src="http://code.jquery.com/jquery-latest.min.js"></script>
	<script src="jquery-csv.min.js"></script>
	<script src="Chart.min.js"></script>
	<script src="chartData.js"></script>
    <script type="text/javascript">
    $(document).ready(function() {

    	//Night Mode (in progress)
    	// $('.container').css({
    	// 	'background' : '#000',
    	// });
    	// $('h1').css({
    	// 	'color' : '#fff'
    	// });

    	//establish some variables    	
    	var urlStem = "https://spreadsheets.google.com/tq?key=";
   		var query = "&tqx=out:csv&callback=processData"
    	var mileageUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Mileage'
    	var paceUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Paces';
    	var sleepUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Sleep';
    	var nutrientsUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=Macronutrients';
    	var avgNutrientsUrl = urlStem + '1VdT0ZqbmH0D2vQS4ZS0nxKGiJesd8vCLM21Bs0r9mxc' + query + '&sheet=avgMacronutrients';

    	var week = 0;
    	var month = 0;
    	var state = "month";
		$('.month').css('border', '2px solid #32BAF9');

    	var uiFont = 'Open Sans';
    	var chartDefaults = {
    		scaleFontFamily: uiFont,
    		tooltipFontFamily: uiFont,
			pointLabelFontFamily: uiFont,
		  	tooltipTitleFontStyle : 'normal'
    	}

    	function newLine(url, url2, valueColumn, name, week, color, valueColumn2, state) {
    		var values = new Array();
    		var labels = new Array();

    		clearCanvas(name, "line");

    		$.ajax({
	        	url: 'http://query.yahooapis.com/v1/public/yql', 
	        	dataType: "jsonp",
	        	data: { 
		            q: "select * from csv where url='" + url + "'",
		            format: 'json'
          		},
	        	success: function(data) {
		    		$.each(data.query.results.row, function(index, object) {
		        		if(index !== "0") {
		        			values[index-1] = eval("parseFloat(data.query.results.row[index].col" + valueColumn + ")");
	        			}
	        			labels[index-1] = data.query.results.row[index].col0;
				    });

		    		if (state != "month") {
						var currentData = getWeek(values, week);
	    				var currentLabels = getWeek(labels, week);
	    			} else { 
	    				var currentData = getMonth(values, month); 
	    				var currentLabels = getMonth(labels, month);
	    			}

	    			var chartData = convertToLineData(color, name, currentLabels, currentData, null);

			       	if (url2) {
			       		if (!valueColumn2)
			       			valueColumn2 = valueColumn;
			       		var values2 = new Array();
				    	$.ajax({
				    		url: 'http://query.yahooapis.com/v1/public/yql', 
				        	dataType: "jsonp",
				        	data: { 
					            q: "select * from csv where url='" + url2 + "'",
					            format: 'json'
			          		},
			          		success: function(data) {
			          			$.each(data.query.results.row, function(index, object) {
					        		if(index !== "0") { 
					        			values2[index-1] = eval("parseFloat(data.query.results.row[index].col" + valueColumn2 + ")");
					        		}
							    });

					    		if (state != "month") {
									var currentData2 = getWeek(values2, week);
				    			} else { 
				    				var currentData2 = getMonth(values2, month); 
				    			}

							    var chartData2 = convertToLineData(color, name, currentLabels, currentData2);

							    chartData2.datasets[0].data = values2;
							    chartData2 = chartData2.datasets[0];

							    chartData.datasets[1] = chartData2;
							    
		    				   	var ctx = document.getElementById(name).getContext("2d");
						    	var myChart = new Chart(ctx);
						    	myChart.Line(chartData, chartDefaults);
						    	return;
			          		}
				    	})
				    }

				   	var ctx = document.getElementById(name).getContext("2d");
			    	var myChart = new Chart(ctx);
	    			myChart.Line(chartData, chartDefaults);
	        	},
	        	error: function() { console.log("Error! Failed to get data set."); }
        	});
    	}

    	function newDoughnut(url, valueColumn1, valueColumn2, valueColumn3, name, week, label1, label2, label3, state) {
    		var values1 = new Array();
    		var values2 = new Array();
    		var values3 = new Array();
    		var value1, value2, value3;
			clearCanvas(name, "doughnut");

	    	$.ajax({
	        	url: 'http://query.yahooapis.com/v1/public/yql', 
	        	dataType: "jsonp",
	        	data: { 
		            q: "select * from csv where url='" + url + "'",
		            format: 'json'
          		},
          		success: function(data) {
					$.each(data.query.results.row, function(index, object) {
						if(index !== "0") {
							values1[index-1] = eval("parseFloat(data.query.results.row[index].col" + valueColumn1 + ")");
							values2[index-1] = eval("parseFloat(data.query.results.row[index].col" + valueColumn2 + ")");
							values3[index-1] = eval("parseFloat(data.query.results.row[index].col" + valueColumn3 + ")");
						}
					});
					value1 = values1.reverse()[week];
					value2 = values2.reverse()[week];
					value3 = values3.reverse()[week];
					var chartData = convertToDoughnutData(value1, value2, value3, label1, label2, label3);
					var ctx = document.getElementById(name).getContext("2d");
			    	var myChart = new Chart(ctx);
			    	var chartOptions = {
			    		segmentShowStroke: false,
			    		percentageInnerCutout: 60
			    	}
	    			myChart.Doughnut(chartData, $.extend(chartDefaults, chartOptions));
          		}
	    	});
	    }

    	function getWeek(data, weeksAgo) {
    		return data.reverse().slice((7*weeksAgo), ((7*weeksAgo)+7)).reverse();
    	}

    	function getMonth(data, monthsAgo) {
    		return data.reverse().slice((30*monthsAgo), ((30*monthsAgo)+30)).reverse();
    	}

    	function clearCanvas(name, chartType) {
			$('#' + name).replaceWith('<canvas id="'+name+'" class="canvas '+chartType+'"></canvas>');
    	}

    	function updateGraphs() {

	    	newLine(mileageUrl, paceUrl, 1, "mileage", week, "red", null, state);
			newLine(sleepUrl, null, 1, "sleep", week, "orange", null, state);
			newLine(nutrientsUrl, nutrientsUrl, 1, "carbs", week, "green", 2, state);
			newLine(nutrientsUrl, null, 3, "protein", week, "blue", null, state);
			newLine(nutrientsUrl, null, 6, "calories", week, "purple", null, state);
			newLine(nutrientsUrl, nutrientsUrl, 4, "fat", week, "red", 5, state);
			newDoughnut(avgNutrientsUrl, 1, 3, 4, "avgMacronutrients", week, "Carbs", "Protein", "Fat", state);

			switch (state) {
				case 'week': 
					if (week <= 0) {
						$('.forward').hide();
					} else {
						$('.forward').show();
					}
					break;
				case 'month':
					if (month <= 0) {
						$('.forward').hide();
					} else {
						$('.forward').show();
					}
					break;
			}


			if (state == "week") {
				switch(week) {
					case 0:
						$('.whichWeek').html('This '+state);
						$('.doughnutTime').html('Last '+state);
						break;
					case 1: 
						$('.whichWeek').html('Last '+state);
						$('.doughnutTime').html('2 '+state+'s Ago');
						break;
					default: 
						$('.whichWeek').html(week +" "+ state +'s Ago');
						$('.doughnutTime').html(week +" "+ state +'s Ago')
						break;
				}	
			} else {
				switch(month) {
					case 0:
						$('.whichWeek').html('This '+state);
						$('.doughnutTime').html('Last Week');
						break;
					case 1: 
						$('.whichWeek').html('Last '+state);
						$('.doughnutTime').html('2 Weeks Ago');
						break;
					default: 
						$('.whichWeek').html(week +" "+ state +'s Ago');
						$('.doughnutTime').html(month +'Weeks Ago')
						break;
				}	
			}

    	}

    	updateGraphs();
        
		$('.back').click(function() {
			switch (state) {
				case "week": 
					week += 1; 
				case "month":
					month +=1; 
			}
			updateGraphs();
		});
		$('.forward').click(function() {
			switch (state) {
				case "week": 
					week -= 1; 
				case "month":
					month -=1; 
			}
			updateGraphs();
		});
		$('.month').click(function() {
			state = "month";
			$('.month').css('border', '2px solid #32BAF9');
			$('.week').css('border', '1px solid #BBBBBB');
			updateGraphs();
		});
		$('.week').click(function() {
			state = "week";
			$('.week').css('border', '2px solid #32BAF9');
			$('.month').css('border', '1px solid #BBBBBB');
			updateGraphs();
		});
	});  
    </script>
</body>
</html>

